const { writeFile, existsSync, mkdirSync } = require('fs');
const { argv } = require('yargs')

require('dotenv').config()
const environment = argv.environment

function writeFileUsingFS(targetPath, environmentFileContent) {
    writeFile(targetPath, environmentFileContent, function (err) {
        if (err) {
            console.log(err)
        }
        if (environmentFileContent !== '') {
            console.log(`Wrote variables to ${targetPath}`)
        }
    })
}

const envDirectory = './src/environments'
const envProd = `${envDirectory}/environment.prod.ts`
const envDev = `${envDirectory}/environment.ts`

// creates the `environments` directory if it does not exist
if (!existsSync(envDirectory)) {
    mkdirSync(envDirectory);
}

//creates the `environment.prod.ts` and `environment.ts` file if it does not exist
writeFileUsingFS(envProd, '')
writeFileUsingFS(envDev, '')

const isProduction = environment === 'prod'
const targetPath = isProduction ? envProd : envDev

const environmentFileContent = `
// This file was autogenerated by dynamically running setEnv.ts and using dotenv for managing API key secrecy

export const firebaseConfig = {
    apiKey: '${process.env.FIREBASE_API_KEY}',
    authDomain: '${process.env.FIREBASE_AUTH_DOMAIN}',
    projectId: '${process.env.FIREBASE_PROJECT_ID}',
    storageBucket: '${process.env.FIREBASE_STORAGE_BUCKET}',
    messagingSenderId: '${process.env.FIREBASE_MESSAGING_SENDER_ID}',
    appId: '${process.env.FIREBASE_APP_ID}'
}

export const environment = {
    production: ${isProduction},
    apiKey: '${process.env.FIREBASE_API_KEY}'
}
`

writeFileUsingFS(targetPath, environmentFileContent)    // appending data into the target file
